name: Daily Crypto Pipeline

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

env:
  # ✅ FIX: Point to the Secret NAME, not the value
  MOTHERDUCK_TOKEN: ${{ secrets.MOTHERDUCK_TOKEN }}

jobs:
  run_pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      - name: Install dependencies
        run: uv sync

      - name: Create dlt secrets
        run: |
          mkdir -p .dlt
          echo "[destination.motherduck.credentials]" > .dlt/secrets.toml
          echo "database = 'crypto_db'" >> .dlt/secrets.toml
          # ✅ This pulls the value from the environment variable we set above
          echo "password = '${{ secrets.MOTHERDUCK_TOKEN }}'" >> .dlt/secrets.toml

      - name: Create dbt profile
        run: |
          mkdir -p ~/.dbt
          echo "brahim:" > ~/.dbt/profiles.yml
          echo "  target: duck" >> ~/.dbt/profiles.yml
          echo "  outputs:" >> ~/.dbt/profiles.yml
          echo "    duck:" >> ~/.dbt/profiles.yml
          echo "      type: duckdb" >> ~/.dbt/profiles.yml
          echo "      path: 'md:crypto_db'" >> ~/.dbt/profiles.yml
          echo "      motherduck_token: '${{ secrets.MOTHERDUCK_TOKEN }}'" >> ~/.dbt/profiles.yml

      - name: Run Ingestion (Python)
        run: uv run python ingest.py

      - name: Run Transformation (dbt)
        working-directory: ./analytics
        run: uv run dbt run